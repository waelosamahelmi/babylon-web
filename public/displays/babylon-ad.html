<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=1920, height=1080">
  <title>Babylon - Tarjoukset</title>
  <style type="text/css">
    * { margin: 0; padding: 0; }
    
    html, body {
      width: 1920px;
      height: 1080px;
      overflow: hidden;
      background: #000;
      font-family: Arial, Helvetica, sans-serif;
    }

    .rotation-wrapper {
      width: 1080px;
      height: 1920px;
      -webkit-transform: rotate(-90deg) translateX(-1080px);
      -moz-transform: rotate(-90deg) translateX(-1080px);
      -ms-transform: rotate(-90deg) translateX(-1080px);
      transform: rotate(-90deg) translateX(-1080px);
      -webkit-transform-origin: top left;
      -moz-transform-origin: top left;
      -ms-transform-origin: top left;
      transform-origin: top left;
      position: absolute;
      top: 0;
      left: 0;
    }

    .promo-display {
      width: 1080px;
      height: 1920px;
      position: relative;
      overflow: hidden;
      background: #1a0a0a;
    }

    .bg-glow {
      position: absolute;
      width: 500px;
      height: 500px;
      top: -150px;
      left: -100px;
      background: #dc2626;
      opacity: 0.2;
      -webkit-border-radius: 50%;
      -moz-border-radius: 50%;
      border-radius: 50%;
      -webkit-filter: blur(80px);
      filter: blur(80px);
      -webkit-animation: glow-pulse 8s ease-in-out infinite;
      -moz-animation: glow-pulse 8s ease-in-out infinite;
      animation: glow-pulse 8s ease-in-out infinite;
    }

    .bg-glow-2 {
      top: auto;
      left: auto;
      bottom: -100px;
      right: -100px;
      background: #ea580c;
      -webkit-animation-delay: 2s;
      -moz-animation-delay: 2s;
      animation-delay: 2s;
    }

    @-webkit-keyframes glow-pulse {
      0%, 100% { opacity: 0.2; -webkit-transform: scale(1); }
      50% { opacity: 0.35; -webkit-transform: scale(1.15); }
    }
    @-moz-keyframes glow-pulse {
      0%, 100% { opacity: 0.2; -moz-transform: scale(1); }
      50% { opacity: 0.35; -moz-transform: scale(1.15); }
    }
    @keyframes glow-pulse {
      0%, 100% { opacity: 0.2; transform: scale(1); }
      50% { opacity: 0.35; transform: scale(1.15); }
    }

    .header {
      position: relative;
      z-index: 100;
      padding: 40px 60px 20px;
      text-align: center;
    }

    .logo-img {
      width: 350px;
      height: 350px;
      -webkit-animation: logo-glow 3s ease-in-out infinite;
      -moz-animation: logo-glow 3s ease-in-out infinite;
      animation: logo-glow 3s ease-in-out infinite;
    }

    @-webkit-keyframes logo-glow {
      0%, 100% { -webkit-filter: drop-shadow(0 0 40px rgba(220, 38, 38, 0.6)); }
      50% { -webkit-filter: drop-shadow(0 0 70px rgba(220, 38, 38, 0.9)); }
    }
    @-moz-keyframes logo-glow {
      0%, 100% { filter: drop-shadow(0 0 40px rgba(220, 38, 38, 0.6)); }
      50% { filter: drop-shadow(0 0 70px rgba(220, 38, 38, 0.9)); }
    }
    @keyframes logo-glow {
      0%, 100% { filter: drop-shadow(0 0 40px rgba(220, 38, 38, 0.6)); }
      50% { filter: drop-shadow(0 0 70px rgba(220, 38, 38, 0.9)); }
    }

    .main-content {
      position: relative;
      z-index: 10;
      height: 1300px;
      text-align: center;
      padding: 0 60px;
    }

    .promo-card {
      display: none;
      text-align: center;
    }

    .promo-card.active {
      display: block;
    }

    .image-wrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 40px;
    }

    .promo-image {
      width: 500px;
      height: 500px;
      -webkit-border-radius: 50%;
      -moz-border-radius: 50%;
      border-radius: 50%;
      border: 8px solid #dc2626;
      -webkit-box-shadow: 0 0 50px rgba(220, 38, 38, 0.5);
      -moz-box-shadow: 0 0 50px rgba(220, 38, 38, 0.5);
      box-shadow: 0 0 50px rgba(220, 38, 38, 0.5);
    }

    .image-border {
      position: absolute;
      top: -12px;
      left: -12px;
      right: -12px;
      bottom: -12px;
      -webkit-border-radius: 50%;
      -moz-border-radius: 50%;
      border-radius: 50%;
      border: 4px solid #f59e0b;
      -webkit-animation: border-rotate 6s linear infinite;
      -moz-animation: border-rotate 6s linear infinite;
      animation: border-rotate 6s linear infinite;
    }

    @-webkit-keyframes border-rotate {
      0% { -webkit-transform: rotate(0deg); border-color: #dc2626; }
      33% { border-color: #ea580c; }
      66% { border-color: #f59e0b; }
      100% { -webkit-transform: rotate(360deg); border-color: #dc2626; }
    }
    @-moz-keyframes border-rotate {
      0% { -moz-transform: rotate(0deg); border-color: #dc2626; }
      33% { border-color: #ea580c; }
      66% { border-color: #f59e0b; }
      100% { -moz-transform: rotate(360deg); border-color: #dc2626; }
    }
    @keyframes border-rotate {
      0% { transform: rotate(0deg); border-color: #dc2626; }
      33% { border-color: #ea580c; }
      66% { border-color: #f59e0b; }
      100% { transform: rotate(360deg); border-color: #dc2626; }
    }

    .discount-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #dc2626;
      color: #fff;
      font-size: 42px;
      font-weight: bold;
      padding: 20px 30px;
      -webkit-border-radius: 15px;
      -moz-border-radius: 15px;
      border-radius: 15px;
      -webkit-box-shadow: 0 8px 30px rgba(220, 38, 38, 0.6);
      -moz-box-shadow: 0 8px 30px rgba(220, 38, 38, 0.6);
      box-shadow: 0 8px 30px rgba(220, 38, 38, 0.6);
      -webkit-animation: badge-bounce 2s ease-in-out infinite;
      -moz-animation: badge-bounce 2s ease-in-out infinite;
      animation: badge-bounce 2s ease-in-out infinite;
    }

    @-webkit-keyframes badge-bounce {
      0%, 100% { -webkit-transform: scale(1) rotate(-3deg); }
      50% { -webkit-transform: scale(1.1) rotate(3deg); }
    }
    @-moz-keyframes badge-bounce {
      0%, 100% { -moz-transform: scale(1) rotate(-3deg); }
      50% { -moz-transform: scale(1.1) rotate(3deg); }
    }
    @keyframes badge-bounce {
      0%, 100% { transform: scale(1) rotate(-3deg); }
      50% { transform: scale(1.1) rotate(3deg); }
    }

    .promo-info {
      margin-bottom: 30px;
    }

    .promo-name {
      font-size: 64px;
      font-weight: bold;
      color: #fff;
      margin-bottom: 15px;
    }

    .promo-description {
      font-size: 28px;
      color: #aaa;
      margin-bottom: 20px;
    }

    .price-container {
      text-align: center;
    }

    .price-label {
      font-size: 28px;
      font-weight: bold;
      color: #fbbf24;
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 10px;
    }

    .old-price {
      font-size: 42px;
      font-weight: bold;
      color: #888;
      text-decoration: line-through;
      margin-bottom: 15px;
    }

    .new-price-wrapper {
      display: inline-block;
      background: #dc2626;
      padding: 20px 50px;
      -webkit-border-radius: 15px;
      -moz-border-radius: 15px;
      border-radius: 15px;
      margin-top: 20px;
      -webkit-box-shadow: 0 10px 40px rgba(220, 38, 38, 0.6);
      -moz-box-shadow: 0 10px 40px rgba(220, 38, 38, 0.6);
      box-shadow: 0 10px 40px rgba(220, 38, 38, 0.6);
      -webkit-animation: price-pulse 2s ease-in-out infinite;
      -moz-animation: price-pulse 2s ease-in-out infinite;
      animation: price-pulse 2s ease-in-out infinite;
    }

    @-webkit-keyframes price-pulse {
      0%, 100% { -webkit-transform: scale(1); }
      50% { -webkit-transform: scale(1.05); }
    }
    @-moz-keyframes price-pulse {
      0%, 100% { -moz-transform: scale(1); }
      50% { -moz-transform: scale(1.05); }
    }
    @keyframes price-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .new-price {
      font-size: 90px;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 3px 0 rgba(0,0,0,0.3);
    }

    .promo-badge-big {
      display: inline-block;
      background: #dc2626;
      padding: 30px 60px;
      -webkit-border-radius: 20px;
      -moz-border-radius: 20px;
      border-radius: 20px;
      text-align: center;
      -webkit-box-shadow: 0 12px 40px rgba(220, 38, 38, 0.6);
      -moz-box-shadow: 0 12px 40px rgba(220, 38, 38, 0.6);
      box-shadow: 0 12px 40px rgba(220, 38, 38, 0.6);
      -webkit-animation: price-pulse 2s ease-in-out infinite;
      -moz-animation: price-pulse 2s ease-in-out infinite;
      animation: price-pulse 2s ease-in-out infinite;
    }

    .promo-badge-value {
      font-size: 80px;
      font-weight: bold;
      color: #fff;
      display: block;
    }

    .promo-badge-label {
      font-size: 24px;
      font-weight: bold;
      color: #fef3c7;
      letter-spacing: 6px;
    }

    .footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 30px 60px;
      background: rgba(0,0,0,0.7);
      text-align: center;
    }

    .cta-text {
      font-size: 22px;
      font-weight: bold;
      color: #fbbf24;
      text-transform: uppercase;
      letter-spacing: 3px;
      -webkit-animation: cta-glow 2s ease-in-out infinite;
      -moz-animation: cta-glow 2s ease-in-out infinite;
      animation: cta-glow 2s ease-in-out infinite;
    }

    @-webkit-keyframes cta-glow {
      0%, 100% { text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); opacity: 0.85; }
      50% { text-shadow: 0 0 20px rgba(251, 191, 36, 0.7); opacity: 1; }
    }
    @-moz-keyframes cta-glow {
      0%, 100% { text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); opacity: 0.85; }
      50% { text-shadow: 0 0 20px rgba(251, 191, 36, 0.7); opacity: 1; }
    }
    @keyframes cta-glow {
      0%, 100% { text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); opacity: 0.85; }
      50% { text-shadow: 0 0 20px rgba(251, 191, 36, 0.7); opacity: 1; }
    }

    .progress-dots {
      margin-top: 20px;
      text-align: center;
    }

    .progress-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin: 0 6px;
      background: #444;
      -webkit-border-radius: 50%;
      -moz-border-radius: 50%;
      border-radius: 50%;
    }

    .progress-dot.active {
      background: #dc2626;
    }

    .loading {
      text-align: center;
      padding-top: 200px;
    }

    .loading-text {
      font-size: 32px;
      color: #888;
    }

    .no-promos {
      text-align: center;
      padding-top: 150px;
    }

    .no-promos-icon {
      font-size: 120px;
      margin-bottom: 30px;
    }

    .no-promos-title {
      font-size: 56px;
      font-weight: bold;
      color: #fff;
      margin-bottom: 20px;
    }

    .no-promos-subtitle {
      font-size: 32px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="rotation-wrapper">
    <div class="promo-display">
      <div class="bg-glow"></div>
      <div class="bg-glow bg-glow-2"></div>

      <div class="header">
        <img src="https://ravintolababylon.fi/logo.png" alt="Logo" class="logo-img">
      </div>

      <div class="main-content" id="main-content">
        <div class="loading">
          <div class="loading-text">Ladataan tarjouksia...</div>
        </div>
      </div>

      <div class="footer">
        <div class="cta-text">üî• Tarjoukset voimassa rajoitetun ajan! üî•</div>
        <div class="progress-dots" id="progress-dots"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var SUPABASE_URL = 'https://ssyhpqfdzbvrkvqdnxyy.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzeWhwcWZkemJ2cmt2cWRueHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTQ0ODcsImV4cCI6MjA3ODYzMDQ4N30.rplVZXLXaMl3x8e6UftdooztYVWFs6v91DLmg3jrorQ';
    var ROTATION_INTERVAL = 6000;

    var promotions = [];
    var currentIndex = 0;
    var rotationTimer = null;
    var categoryImages = {};

    function formatPrice(price) {
      return parseFloat(price).toFixed(2) + '‚Ç¨';
    }

    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(text));
      return div.innerHTML;
    }

    function makeRequest(method, endpoint, callback) {
      var xhr;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
      }
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              var data = JSON.parse(xhr.responseText);
              callback(null, data);
            } catch (e) {
              callback(e, null);
            }
          } else {
            callback(new Error('Request failed: ' + xhr.status), null);
          }
        }
      };
      
      var url = SUPABASE_URL + '/rest/v1/' + endpoint;
      xhr.open(method, url, true);
      xhr.setRequestHeader('apikey', SUPABASE_ANON_KEY);
      xhr.setRequestHeader('Authorization', 'Bearer ' + SUPABASE_ANON_KEY);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send();
    }

    function fetchPromotions() {
      // Fetch menu items with offers
      makeRequest('GET', 'menu_items?is_available=eq.true&or=(offer_price.not.is.null,offer_percentage.gt.0)&select=*', function(err, offerItems) {
        if (err) {
          console.log('Error fetching offers:', err);
          offerItems = [];
        }

        // Fetch all items for fallback images
        makeRequest('GET', 'menu_items?is_available=eq.true&image_url=not.is.null&select=category_id,image_url', function(err2, allItems) {
          if (err2) {
            console.log('Error fetching all items:', err2);
            allItems = [];
          }

          // Build category image map (global)
          categoryImages = {};
          for (var i = 0; i < allItems.length; i++) {
            var item = allItems[i];
            if (item.image_url && item.category_id) {
              if (!categoryImages[item.category_id]) {
                categoryImages[item.category_id] = [];
              }
              categoryImages[item.category_id].push(item.image_url);
            }
          }

          function getCategoryImage(categoryId) {
            // Always get a random image from the category
            var images = categoryImages[categoryId];
            if (images && images.length > 0) {
              return images[Math.floor(Math.random() * images.length)];
            }
            // Fallback to any random image
            var allImages = [];
            for (var key in categoryImages) {
              allImages = allImages.concat(categoryImages[key]);
            }
            if (allImages.length > 0) {
              return allImages[Math.floor(Math.random() * allImages.length)];
            }
            return 'https://placehold.co/500x500/1a0a0a/dc2626?text=üçï';
          }

          // Fetch promotions
          var now = new Date().toISOString();
          makeRequest('GET', 'promotions?is_active=eq.true&start_date=lte.' + now + '&end_date=gte.' + now + '&select=*', function(err3, promos) {
            if (err3) {
              console.log('Error fetching promotions:', err3);
              promos = [];
            }

            promotions = [];

            // Process offer items
            for (var j = 0; j < offerItems.length; j++) {
              var item = offerItems[j];
              var discountPercent = item.offer_percentage;
              if (!discountPercent && item.offer_price && item.price) {
                discountPercent = Math.round((1 - item.offer_price / item.price) * 100);
              }
              
              if (item.offer_price || discountPercent > 0) {
                promotions.push({
                  type: 'offer',
                  id: item.id,
                  name: item.name,
                  description: item.description,
                  image: item.image_url || getCategoryImage(item.category_id),
                  originalPrice: item.price,
                  offerPrice: item.offer_price || (item.price * (1 - discountPercent / 100)),
                  discountPercent: discountPercent,
                  categoryId: item.category_id
                });
              }
            }

            // Process promotions - always use a random category image
            for (var k = 0; k < promos.length; k++) {
              var promo = promos[k];
              var discountDisplay = null;
              if (promo.discount_type === 'percentage') {
                discountDisplay = promo.discount_value;
              }
              
              promotions.push({
                type: 'promotion',
                id: promo.id,
                name: promo.name,
                description: promo.description,
                image: getCategoryImage(promo.category_id),
                discountPercent: discountDisplay,
                discountType: promo.discount_type,
                discountValue: promo.discount_value,
                originalPrice: null,
                offerPrice: promo.discount_type === 'fixed' ? promo.discount_value : null,
                categoryId: promo.category_id
              });
            }

            renderPromotions();
          });
        });
      });
    }

    function renderPromotions() {
      var content = document.getElementById('main-content');
      var dotsContainer = document.getElementById('progress-dots');

      if (promotions.length === 0) {
        content.innerHTML = '<div class="no-promos">' +
          '<div class="no-promos-icon">üçï</div>' +
          '<div class="no-promos-title">Tervetuloa Babyloniin!</div>' +
          '<div class="no-promos-subtitle">Tutustu maukkaisiin ruokiimme</div>' +
          '</div>';
        dotsContainer.innerHTML = '';
        return;
      }

      var html = '';
      for (var i = 0; i < promotions.length; i++) {
        var promo = promotions[i];
        
        var discountBadge = '';
        if (promo.type === 'offer' && promo.discountPercent) {
          discountBadge = '<div class="discount-badge">-' + promo.discountPercent + '%</div>';
        }

        var priceHtml = '';
        if (promo.originalPrice && promo.offerPrice) {
          priceHtml = '<div class="price-label">Ennen</div>' +
            '<div class="old-price">' + formatPrice(promo.originalPrice) + '</div>' +
            '<div class="price-label">Nyt vain</div>' +
            '<div class="new-price-wrapper">' +
            '<span class="new-price">' + formatPrice(promo.offerPrice) + '</span>' +
            '</div>';
        } else if (promo.type === 'promotion') {
          if (promo.discountType === 'percentage') {
            priceHtml = '<div class="promo-badge-big">' +
              '<span class="promo-badge-value">-' + promo.discountValue + '%</span>' +
              '<span class="promo-badge-label">ALENNUS</span>' +
              '</div>';
          } else if (promo.discountType === 'fixed') {
            priceHtml = '<div class="promo-badge-big">' +
              '<span class="promo-badge-value">-' + formatPrice(promo.discountValue) + '</span>' +
              '<span class="promo-badge-label">ALENNUS</span>' +
              '</div>';
          }
        } else if (promo.offerPrice) {
          priceHtml = '<div class="price-label">Hinta</div>' +
            '<div class="new-price-wrapper">' +
            '<span class="new-price">' + formatPrice(promo.offerPrice) + '</span>' +
            '</div>';
        }

        var descHtml = promo.description ? '<div class="promo-description">' + escapeHtml(promo.description) + '</div>' : '';

        html += '<div class="promo-card" data-index="' + i + '">' +
          '<div class="image-wrapper">' +
          '<div class="image-border"></div>' +
          '<img src="' + escapeHtml(promo.image) + '" alt="' + escapeHtml(promo.name) + '" class="promo-image" onerror="this.src=\'https://placehold.co/500x500/1a0a0a/dc2626?text=üçï\'">' +
          discountBadge +
          '</div>' +
          '<div class="promo-info">' +
          '<div class="promo-name">' + escapeHtml(promo.name) + '</div>' +
          descHtml +
          '<div class="price-container">' + priceHtml + '</div>' +
          '</div>' +
          '</div>';
      }

      content.innerHTML = html;

      var dotsHtml = '';
      for (var d = 0; d < promotions.length; d++) {
        dotsHtml += '<span class="progress-dot" data-index="' + d + '"></span>';
      }
      dotsContainer.innerHTML = dotsHtml;

      startRotation();
    }

    function startRotation() {
      if (rotationTimer) {
        clearInterval(rotationTimer);
      }
      
      currentIndex = 0;
      showPromo(currentIndex);

      if (promotions.length > 1) {
        rotationTimer = setInterval(function() {
          currentIndex = (currentIndex + 1) % promotions.length;
          showPromo(currentIndex);
        }, ROTATION_INTERVAL);
      }
    }

    function showPromo(index) {
      var cards = document.getElementsByClassName('promo-card');
      var dots = document.getElementsByClassName('progress-dot');

      for (var i = 0; i < cards.length; i++) {
        if (i === index) {
          cards[i].className = 'promo-card active';
        } else {
          cards[i].className = 'promo-card';
        }
      }

      for (var j = 0; j < dots.length; j++) {
        if (j === index) {
          dots[j].className = 'progress-dot active';
        } else {
          dots[j].className = 'progress-dot';
        }
      }
    }

    // Initialize when page loads
    if (window.addEventListener) {
      window.addEventListener('load', fetchPromotions, false);
    } else if (window.attachEvent) {
      window.attachEvent('onload', fetchPromotions);
    } else {
      window.onload = fetchPromotions;
    }

    // Refresh every 5 minutes
    setInterval(fetchPromotions, 300000);
  </script>
</body>
</html>
